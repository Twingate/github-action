name: 'Connect to Twingate'
description: 'Connects to Twingate protected resources from your Github Action workflow'
branding:
  icon: 'arrow-right-circle'
  color: 'black'
inputs:
  service-key:
    description: 'Twingate Service Key'
    required: true
  enable-verification:
    description: 'Set to true to verify that the Twingate connection is active after setup'
    required: false
    default: 'false'
  verification-timeout-seconds:
    description: 'Timeout duration (in seconds) for verifying the Twingate connection. Only used if `enable-verification: true`. Default is 60 seconds.'
    required: false
    default: '60'
  expected-outbound-ips:
    description: 'Comma-separated list of outbound IPs expected after successful Twingate connection verification.'
    required: false
    default: ''
runs:
  using: "composite"
  steps:
    - name: Error if unsupported runner.os
      if: runner.os != 'Linux' && runner.os != 'Windows'
      shell: bash
      run: |
        echo "Unsupported Runner OS: ${{ runner.os }}"
        exit 1

    - name: Install Twingate (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt update
        echo "deb [trusted=yes] https://packages.twingate.com/apt/ /" | sudo tee /etc/apt/sources.list.d/twingate.list
        sudo apt-get update -o Dir::Etc::sourcelist="sources.list.d/twingate.list" -o Dir::Etc::sourceparts="-" -o APT::Get::List-Cleanup="0"
        sudo apt install -yq twingate
    
    - name: Setup and start Twingate (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        echo '${{ inputs.service-key }}' | sudo twingate setup --headless -
        MAX_RETRIES=5
        WAIT_TIME=5
        n=0

        while [ $n -lt $MAX_RETRIES ]; do
          echo "Starting Twingate service..."
          set +xe
          twingate start

          echo "Waiting $WAIT_TIME seconds for Twingate service to start..."
          sleep $WAIT_TIME

          status=$(twingate status)
          echo "Twingate service status: '$status'"

          if [ "$status" = "online" ]; then
            echo "Twingate service is connected."
            twingate resources
            break
          else
            twingate stop
            journalctl -u twingate --no-pager
          fi

          # Increment the retry counter and wait time
          n=$((n+1))
          WAIT_TIME=$((WAIT_TIME+5))

          echo "Twingate service is not connected. Retrying ..."
        done

        if [ $n -eq $MAX_RETRIES ]; then
          echo "Twingate service failed to connect."
          exit 1
        fi

    - name: Verify Twingate Connection (Linux)
      if: runner.os == 'Linux' && inputs.enable-verification == 'true'
      shell: bash
      run: |
        sudo cat /etc/resolv.conf
        START_TIME=$(date +%s)
        TIMEOUT=${{ inputs.verification-timeout-seconds }}
        # Remove 's' from the timeout value if present
        TIMEOUT=${TIMEOUT%s}
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED_TIME=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED_TIME -ge $TIMEOUT ]; then
            echo "❌ Timeout reached after $TIMEOUT seconds"
            echo "Last verification failed. Expected: ${{ inputs.expected-outbound-ips }}"
            exit 1
          fi
          
          OUTBOUND_IP=$(curl -s ifconfig.io)
          echo "[$ELAPSED_TIME/$TIMEOUT seconds] Current outbound IP: $OUTBOUND_IP"

          echo "${{ inputs.expected-outbound-ips }}" | tr ',' '\n' | grep -qw "$OUTBOUND_IP" && { echo "✅ Verified"; exit 0; }
          
          echo "❌ IP verification failed"
          echo "Expected: ${{ inputs.expected-outbound-ips }}"
          echo "Got: $OUTBOUND_IP"
          echo "Retrying in 5 seconds..."
          sleep 5
        done

    - name: Install and Start Twingate (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
          Invoke-WebRequest https://api.twingate.com/download/windows?installer=msi -OutFile .\twingate_client.msi

          Set-Content .\key.json  '${{ inputs.service-key }}'
          $key_path = (Get-Item .\key.json | Resolve-Path).ProviderPath

          Start-Process msiexec.exe -Wait -ArgumentList "/i twingate_client.msi service_secret=$key_path /quiet"
          
          Start-Service twingate.service
          Start-Sleep -Seconds 10
          Get-Service twingate.service
