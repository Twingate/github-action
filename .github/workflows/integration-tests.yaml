name: Integration Tests

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'

jobs:
  test-linux:
    strategy:
      max-parallel: 4
      matrix:
        runs-on: [ubuntu-latest, ubuntu-24.04, ubuntu-22.04, ubuntu-24.04-arm, ubuntu-22.04-arm]
        include:
          - runs-on: ubuntu-latest
            service-key: SERVICE_KEY
          - runs-on: ubuntu-24.04
            service-key: SERVICE_KEY1
          - runs-on: ubuntu-22.04
            service-key: SERVICE_KEY2
          - runs-on: ubuntu-24.04-arm
            service-key: SERVICE_KEY_ARM1
          - runs-on: ubuntu-22.04-arm
            service-key: SERVICE_KEY_ARM2
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 5
    steps:
      - name: Test published action
        uses: twingate/github-action@main
        with:
          service-key: ${{ secrets[matrix.service-key] }}
          debug: ${{ inputs.debug || 'false' }}

      - name: Verify Twingate status
        run: twingate status

      - name: Access a secure resource
        env:
          TEST_URL: http://business.prod.beamreachinc.int/
        run: |
          echo "Testing access to $TEST_URL"
          curl -v --fail $TEST_URL

      - name: Print client logs
        if: always()
        run: journalctl -u twingate

  test-linux-docker:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:24.04
      options: --privileged
    timeout-minutes: 10
    steps:
      - name: Test published action
        uses: twingate/github-action@main
        with:
          service-key: ${{ secrets.SERVICE_KEY }}
          debug: ${{ inputs.debug || 'false' }}

      - name: Verify Twingate status
        run: twingate status

      - name: Access a secure resource
        env:
          TEST_URL: http://business.prod.beamreachinc.int/
        run: |
          curl -v $TEST_URL

      - name: Print client logs
        if: always()
        run: |
          if command -v journalctl >/dev/null 2>&1; then
            journalctl -u twingate
          elif [ -f /var/log/twingated.log ]; then
            cat /var/log/twingated.log
          else
            echo "No Twingate logs found"
          fi

  test-windows:
    strategy:
      max-parallel: 4
      matrix:
        runs-on: [windows-latest, windows-2025, windows-2022]
        include:
          - runs-on: windows-latest
            service-key: SERVICE_KEY_WIN1
          - runs-on: windows-2025
            service-key: SERVICE_KEY_WIN2
          - runs-on: windows-2022
            service-key: SERVICE_KEY_WIN3
    runs-on: ${{ matrix.runs-on }}
    timeout-minutes: 6
    steps:
      - name: Test published action
        uses: twingate/github-action@main
        with:
          service-key: ${{ secrets[matrix.service-key] }}
          debug: ${{ inputs.debug || 'false' }}

      - name: Access a secure resource
        shell: powershell
        env:
          TEST_URL: http://business.prod.beamreachinc.int/
        run: |
          Write-Host "Testing access to $env:TEST_URL"
          Invoke-WebRequest -Uri $env:TEST_URL -Verbose -TimeoutSec 10 -UseBasicParsing

      - name: Print client logs
        shell: powershell
        if: always()
        run: Get-Content "$env:PROGRAMDATA\Twingate\logs\twingate.service.log"

      - name: Print installer log
        shell: powershell
        if: always()
        run: Get-Content "install.log"
